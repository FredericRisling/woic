---
import { getEntry } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/layout/Header.astro';
import Footer from '../../components/layout/Footer.astro';
import Hero from '../../components/ui/Hero.astro';
import Section from '../../components/ui/Section.astro';
import Container from '../../components/ui/Container.astro';
import YouTubeEmbed from '../../components/ui/YouTubeEmbed.astro';
import { getLatestVideos } from '../../lib/youtube';

const lang = 'en';
const pageData = await getEntry('pages', `${lang}/media`);

// Fetch the latest YouTube videos at build time (1 featured + 3 for the grid)
const youtubeSection = pageData.data.sections.find(s => s.youtubeEmbed);
const videos = youtubeSection?.youtubeEmbed
  ? await getLatestVideos(youtubeSection.youtubeEmbed, 4)
  : [];
const latestVideo = videos[0] ?? null;
const previousVideos = videos.slice(1);
---

<BaseLayout
  title={pageData.data.meta.title}
  description={pageData.data.meta.description}
  lang={lang}
>
  <Header slot="default-header" lang={lang} />

  <Hero
    title={pageData.data.hero.title}
    subtitle={pageData.data.hero.subtitle}
  />

  {pageData.data.sections.map(section => {
    if (section.type === 'text') {
      return (
        <Section title={section.title}>
          <Container size="md">
            <div class="text-center mb-8">
              <p class="text-lg text-neutral-600 dark:text-neutral-400 mb-6">
                {section.content}
              </p>
              {section.youtubeEmbed ? (
                <YouTubeEmbed
                  videoId={latestVideo?.videoId}
                  title={latestVideo?.title}
                  channelUrl={`https://www.youtube.com/@${section.youtubeEmbed}`}
                  fallbackText={section.placeholder || 'Watch on YouTube'}
                />
              ) : (
                <div class="aspect-video bg-neutral-200 dark:bg-neutral-800 rounded-lg flex items-center justify-center">
                  <p class="text-neutral-500 dark:text-neutral-400">
                    {section.placeholder}
                  </p>
                </div>
              )}
            </div>
          </Container>
        </Section>
      );
    }

    if (section.type === 'media') {
      return (
        <Section background={section.background} title={section.title}>
          <Container size="lg">
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
              {previousVideos.length > 0
                ? previousVideos.map(video => (
                    <div class="bg-white dark:bg-neutral-900 rounded-lg overflow-hidden shadow-sm">
                      <YouTubeEmbed
                        videoId={video.videoId}
                        title={video.title}
                        channelUrl={`https://www.youtube.com/@${youtubeSection?.youtubeEmbed}`}
                        fallbackText="Watch on YouTube"
                      />
                      <div class="p-4">
                        <h3 class="font-bold text-neutral-900 dark:text-neutral-100 mb-2">
                          {video.title}
                        </h3>
                      </div>
                    </div>
                  ))
                : section.videos?.map(video => (
                    <div class="bg-white dark:bg-neutral-900 rounded-lg overflow-hidden shadow-sm">
                      <div class="aspect-video bg-neutral-200 dark:bg-neutral-800 flex items-center justify-center">
                        <span class="text-neutral-500 dark:text-neutral-400">Video preview</span>
                      </div>
                      <div class="p-4">
                        <h3 class="font-bold text-neutral-900 dark:text-neutral-100 mb-2">
                          {video.title}
                        </h3>
                        <p class="text-sm text-neutral-600 dark:text-neutral-400">
                          {video.description}
                        </p>
                      </div>
                    </div>
                  ))
              }
            </div>
          </Container>
        </Section>
      );
    }

    if (section.type === 'html') {
      return (
        <Section title={section.title}>
          <Container size="md">
            <div class="prose dark:prose-invert max-w-none" set:html={section.html} />
          </Container>
        </Section>
      );
    }
  })}

  <Footer slot="default-footer" lang={lang} />
</BaseLayout>
